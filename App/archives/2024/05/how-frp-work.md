# FRP工作原理及代码实现

:::info

尝试造轮子，感觉会有帮助。先贴个 [frp 官方仓库](https://github.com/fatedier/frp)。

:::

:::warning

计网基础

:::

## 传统内网穿透

内网宽带中的主机不可被外网宽带主机或者其他内网宽带中的主机访问，这不方便。我们可以使用内网穿透解决这个痛点。

生活中使用内网穿透的例子，常见的就是连进寝室网和室友联机打游戏，或者是在公司连进自家网络方便办公（危）。当然，这两项有时候其实并不需要内网穿透技术，简单的端口转发也可以实现。

但在实际渗透时，单个端口转发自然是不够用了，很多时候我们需要全流量的数据代理才方便操作。而 FRP 正是为此而生的。FRP 可以实现代理全端口、全流量的数据，我们在拿到一定权限时，可以将打下的内网机器网络穿透到我们公网主机上，然后安全人员就可以使用 SocksCap 或者 Proxifier 等工具进行连接，进而实现在本地访问目标内网，也更方便安全人员进行权限维持或者横向等进一步操作。

先学习内网穿透的原理。比较易懂的方式就是扔一张网络拓扑图：

![20240508191433](https://img.ma5hr00m.top/blog/20240508191433.png)

内网宽带主机不可被外部访问，但可以主动去访问外部；我们让内网 A 中的主机主动且持续访问一台公网主机（建立通道），然后公网主机再不间断地将来自内网 A 的请求不断转发给处于内网 B 中的另一台主机，这样就可以实现处于不同内网宽带中的两台主机的互连（通过公网主机的转发）。

## 点对点内网穿透

当转发数据量很大时，传统内网穿透会对中转服务器造成较大的压力。点对点内网穿透就适用于这种需要传输大量数据且不希望流量经过服务器的情况。

常见的 p2p 技术有 UDP 打洞技术和 TCP 打洞技术，后者的使用范围小于前者且实现原理也相对复杂一些，这里不做详细介绍。下面会以应用广泛的 UDP 打洞技术为例介绍点对点内网穿透的基本实现原理。

同样是先看网络拓扑图：

![20240508195500](https://img.ma5hr00m.top/blog/20240508195500.png)

一句话概括：处于不同内网宽带的两台主机，借助中间主机的协助，在各自的 NAT 网关建立相关表项，实现双方报文穿透 NAT 网关直达对方主机。

此外，两台主机想要建立通道还需要一种用于建立 Session 的机制，具体的 Session 建立机制如下：

1. 客户端 A 向集中服务器发送消息，请求帮助建立与客户端 B 的 UDP 连接；
2. 集中服务器将包含B的外网和内网地址信息的消息发送给 A，同时将包含 A 的外网和内网地址信息的消息发送给 B，使得 A 和 B 都知道对方的地址信息；
3. A 收到 B 的地址信息后，开始向 B 发送 UDP 数据包，并自动锁定第一个得到响应的 B 的地址，同样，B 也向 A 发送 UDP 数据包，并锁定第一个得到响应的 A 的地址。通过向对方的 NAT 设备发送数据包，打开了 A 与 B 之间的“洞”，实现了直接通信；
4. 一旦确认可以通过对方的外网地址发送数据包，程序停止发送用于打洞的数据包，开始真正的 p2p 数据传输。

:::tip Session

在 UDP 打洞过程中，通过 `Session` 建立机制，客户端 A 和 B 能够获取对方的地址信息，并通过集中服务器的协助建立直接连接。这个 `Session` 包含了双方的地址信息，帮助客户端 A 和 B 了解对方的位置，从而实现直接通信。因此，`Session` 在这里更多地指代连接建立的过程和所需的信息，而非特定的报文字段。

:::

好了，现在我们已经完成了打洞的过程，下一步就该考虑怎么维持这个“洞”了。

当然，UDP 协议在 NAT 设备中的“打洞”过程并不是百分之百可靠的。这是因为大多数 NAT 设备都有一个内置的 UDP 空闲计时器。如果在一定时间内没有 UDP 流量，NAT 设备会关闭之前通过“打洞”过程创建的通道。这个机制是 NAT 设备用来管理和优化资源的一种方式，因为长时间空闲的连接可能意味着不再需要维持该连接。

但对于 p2p 应用程序来说，自然是想让这个“洞”保持开放，不受 NAT 设备空闲计时器的影响。这就需要在 NAT 穿透后设置一个有效期限。这通常是通过在两个想要通信的端点之间定期发送心跳包来实现的。这些心跳包是小的、定期的网络包，它们保持了 NAT 设备上的映射条目，防止它们因为超时而被删除。

至此，我们就了解了 UDP 打洞的全流程，可以归纳为如下三步：

1. **建立 Session**：在 p2p 网络中，集中服务器帮助位于 NAT 后的客户端 AB 相互发现。服务器记录客户端的内网和经过 NAT 转换后的外网地址信息。这样，AB 就可以知道对方的公网IP地址和端口号。

2. **打洞**：客户端 AB 通过集中服务器交换了各自的地址信息后，它们开始尝试直接通信。AB 会向对方的公网地址发送 UDP 数据包，以建立直接的连接。这个过程就是所谓的“打洞”。

3. **维持连接**：一旦“洞”被打开，客户端 AB 就可以直接通信了。为了保持这个连接，它们需要定期交换心跳包，这些包会告诉 NAT 设备这个连接仍然是活跃的，从而防止 NAT 设备因为超时而关闭这个“洞”。

:::warning

不同类型的 NAT 对 UDP 打洞的成功率有不同的影响。例如，对称型 NAT（Symmetric NAT）对于每个外部 IP 地址和端口的请求都会分配一个不同的内部端口，这使得打洞变得更加困难；而锥形 NAT（Cone NAT）则对打洞更为友好。

:::

:::info “打洞”

之前听过社团成员聊过 wireguard 打洞，但那个时候听不懂，不知道是在干什么，现在想来算是很形象的形容了。

:::

## 阅读 FRP 核心源码

:::tip

在开始阅读源码前，还有一点点前置知识需要知道：网络通信中的心跳机制。前文也有提到 *“心跳包”* 这个概念，如果读者对此尚不了解，可以看看下面这篇博客，或许能让你在阅读 FRP 源码时更轻松一些：

[网络通信中的心跳机制](https://ma5hr00m.top/archives/2024/05/heartbeat.html)

:::

## 基于 Golang 的简单实现

Ok，现在我们已经理解了内网穿透的实现原理，我们现在可以尝试自己写个试试。

:::danger

work in progress...

:::


<div>
<!--
- [内网穿透详解](https://www.cnblogs.com/cyrus0w/p/13123504.html) 👍
- [P2P 打洞原理](https://mthli.xyz/p2p-hole-punching/) 👍
- [点对点内网穿透](https://gofrp.org/zh-cn/docs/examples/xtcp/)
- [UDP内网穿透和打洞原理与代码实现](https://zhuanlan.zhihu.com/p/672215270.)
- [frp v0.5.0 源码分析 _](https://www.joxrays.com/frp-source-code/) 👍
-->
</div>